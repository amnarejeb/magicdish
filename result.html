<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MagicDish - Recipe Result</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#28A745' }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    ol.steps {
      counter-reset: step;
      list-style: none;
      padding: 0;
    }

    ol.steps li {
      counter-increment: step;
      display: grid;
      grid-template-columns: 32px 1fr;
      gap: 10px;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 8px;
      background: #fafafa;
    }

    ol.steps li::before {
      content: counter(step);
      display: grid;
      place-items: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #28A745;
      color: white;
      font-weight: bold;
    }

    ul.ingredients {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    ul.ingredients li {
      padding: 8px 10px;
      border-left: 3px solid #28A745;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    #recipeContent {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    #recipeContent.show {
      opacity: 1;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center">
      <svg class="animate-spin h-10 w-10 text-primary mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16 8 8 0 01-8-8z"></path>
      </svg>
      <p class="text-gray-700 font-medium">Generating your magical recipe...</p>
    </div>
  </div>

  <header class="bg-transparent">
    <div class="container mx-auto px-4 py-3 flex items-center">
      <h1 class="text-3xl font-['Pacifico'] text-primary">MagicDish</h1>
      <i class="ri-magic-line text-primary text-xl ml-2"></i>
    </div>
  </header>

  <main class="pt-28 pb-16 px-4 flex-grow">
    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-8">
      <h2 class="text-3xl font-bold text-primary mb-6 text-center">Your Magical Recipe</h2>

      <div id="meta" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6"></div>
      <h3 id="title" class="text-2xl font-semibold text-gray-900 mb-4 text-center"></h3>

      <div id="recipeContent">
        <section class="mb-8">
          <h4 class="text-xl font-semibold text-primary mb-3">Ingredients</h4>
          <ul id="ingredients" class="ingredients">
            <li class="text-gray-500">⏳ Generating your recipe...</li>
          </ul>
        </section>

        <section>
          <h4 class="text-xl font-semibold text-primary mb-3">Instructions</h4>
          <ol id="instructions" class="steps"></ol>
        </section>
      </div>

      <div id="error" class="hidden mt-6 text-center text-red-500 font-semibold"></div>

      <div class="mt-8 text-center">
        <a href="index.html"
          class="inline-block bg-primary text-white px-6 py-3 rounded-full text-lg hover:bg-green-700 transition">
          Generate Another Recipe
        </a>
      </div>
    </div>
  </main>

  <script>
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
    const API_KEY = "API key";

    const titleEl = document.getElementById("title");
    const ingredientsEl = document.getElementById("ingredients");
    const instructionsEl = document.getElementById("instructions");
    const metaEl = document.getElementById("meta");
    const errorDiv = document.getElementById("error");
    const recipeContent = document.getElementById("recipeContent");
    const loadingOverlay = document.getElementById("loadingOverlay");

    function buildPrompt(ingredients) {
      return `You are a professional chef AI.
Detect the language of this input: "${ingredients}".
ALWAYS answer in the SAME language of the input.

Using ONLY these ingredients (if reasonable): ${ingredients}.
Return your answer in EXACTLY this plain text structure:

Title: <short title>
Servings: <number>
Prep time: <time>
Cook time: <time>
Total time: <time>

Ingredients:
- item 1
- item 2

Instructions:
1. step one
2. step two`;
    }

    function parseRecipe(text) {
      const get = (label) => {
        const m = text.match(new RegExp(`^${label}:\\s*(.+)$`, "mi"));
        return m ? m[1].trim() : "";
      };

      const title = get("Title") || "Recipe";
      const servings = get("Servings");
      const prep = get("Prep time");
      const cook = get("Cook time");
      const total = get("Total time");

      const ingMatch = text.match(/Ingredients:\s*([\s\S]*?)\n\s*Instructions:/i);
      const ingBlock = ingMatch ? ingMatch[1].trim() : "";

      const instMatch = text.match(/Instructions:\s*([\s\S]*)$/i);
      const instBlock = instMatch ? instMatch[1].trim() : "";

      const ingredients = ingBlock.split(/\r?\n/).map(l => l.replace(/^\s*[-•*]\s*/, "").trim()).filter(Boolean);
      const instructions = instBlock.split(/\r?\n/).map(l => l.replace(/^\s*\d+\.\s*/, "").trim()).filter(Boolean);

      return { title, servings, prep, cook, total, ingredients, instructions };
    }

    function renderMeta({ servings, prep, cook, total }) {
      const card = (icon, label, value) => `
        <div class="bg-gray-50 border rounded-xl p-4">
          <div class="flex items-center gap-3">
            <i class="${icon} text-primary text-xl"></i>
            <div>
              <div class="text-sm text-gray-500">${label}</div>
              <div class="text-base font-semibold text-gray-900">${value || "-"}</div>
            </div>
          </div>
        </div>
      `;
      metaEl.innerHTML = `
        ${card("ri-time-line", "Prep", prep)}
        ${card("ri-restaurant-line", "Servings", servings)}
        ${card("ri-hourglass-line", "Total", total || cook)}
      `;
    }

    function renderRecipe(data) {
      titleEl.textContent = data.title;
      recipeContent.style.display = "block";
      setTimeout(() => recipeContent.classList.add("show"), 50);

      ingredientsEl.innerHTML = data.ingredients.length
        ? data.ingredients.map(item => `<li>${item}</li>`).join("")
        : `<li class="text-gray-500">No ingredients parsed.</li>`;

      instructionsEl.innerHTML = data.instructions.length
        ? data.instructions.map(step => `<li>${step}</li>`).join("")
        : `<li>No instructions parsed.</li>`;

      renderMeta(data);
    }

    async function generateRecipe(ingredients) {
      try {
        loadingOverlay.classList.remove("hidden");

        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: buildPrompt(ingredients) }] }]
          }),
        });

        const data = await response.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

        if (!raw) throw new Error("No recipe generated.");

        const parsed = parseRecipe(raw);
        renderRecipe(parsed);

      } catch (err) {
        errorDiv.classList.remove("hidden");
        errorDiv.textContent = "❌ Error generating recipe: " + err.message;
      } finally {
        loadingOverlay.classList.add("hidden");
      }
    }

    const ingredients = localStorage.getItem("ingredients");
    if (ingredients) {
      generateRecipe(ingredients);
    } else {
      ingredientsEl.innerHTML = `<li class="text-red-500">⚠️ No ingredients found.</li>`;
    }
  </script>
</body>
</html>
